% Teresa Peña Mercadé February 2021
% Manel Soria April 2021

% This code allows to obtain the longitude and latitude of the pixels of an
% image that correspond to a celestial body.

close all
clear;

%% KERNELS & SUMMARY FILES

spacecraftid='CASSINI';
encounter='RHEA';

% EXAMPLE IMAGE: co-iss-n1511700504

MK={'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/ik/cas_caps_v03.ti',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/ik/cas_cda_v01.ti',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/ik/cas_cirs_v09.ti',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/ik/cas_inms_v02.ti',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/ik/cas_iss_v10.ti',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/ik/cas_mag_v01.ti',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/ik/cas_mimi_v11.ti',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/ik/cas_radar_v11.ti',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/ik/cas_rpws_v01.ti',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/ik/cas_rss_v03.ti',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/ik/cas_sru_v02.ti',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/ik/cas_uvis_v06.ti',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/ik/cas_vims_v06.ti',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/fk/cas_dyn_v03.tf',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/fk/cas_mimi_v202.tf',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/fk/cas_rocks_v18.tf',...
    'https://naif.jpl.nasa.gov/pub/naif/CASSINI/kernels/fk/cas_v42.tf',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/lsk/naif0012.tls',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/pck/pck00010.tpc',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/sclk/cas00172.tsc',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/ck/cas_skr_sls4_north_06095_09258_v2.bc',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/ck/cas_skr_sls4_south_04255_11008_v2.bc',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/ck/cas_skr_slsm_north_05084_10192_v2.bc',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/ck/cas_skr_slsm_south_04001_10192_v2.bc',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/spk/140809BP_IRRE_00256_25017.bsp',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/spk/180927AP_RE_90165_18018.bsp',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/spk/sat138.bsp',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/nh-j_p_ss-spice-6-v1.0/nhsp_1000/data/spk/de430.bsp',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/ck/05182_05187ra.bc',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/ck/05187_05192ra.bc',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/ck/05192_05197ra.bc',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/ck/05197_05202ra.bc',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/ck/05202_05207ra.bc',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/ck/05207_05212ra.bc',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/ck/05212_05217ra.bc',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/ck/05212_05242py_as_flown.bc',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/ck/05217_05222ra.bc',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/ck/05222_05227ra.bc',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/ck/05227_05232ra.bc',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/ck/05232_05237ra.bc',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/ck/05237_05242ra.bc',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/ck/05242_05247ra.bc',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/ck/05242_05281py_as_flown.bc',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/ck/05247_05252ra.bc',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/ck/05252_05257ra.bc',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/ck/05257_05262ra.bc',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/ck/05262_05267ra.bc',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/ck/05267_05272ra.bc',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/ck/05272_05277ra.bc',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/ck/05277_05282ra.bc',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/ck/05281_05316py_as_flown.bc',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/ck/05282_05287ra.bc',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/ck/05287_05292ra.bc',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/ck/05292_05297ra.bc',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/ck/05297_05302ra.bc',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/ck/05302_05307ra.bc',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/ck/05307_05312ra.bc',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/ck/05312_05317ra.bc',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/ck/05316_05351py_as_flown.bc',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/ck/05317_05322ra.bc',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/ck/05322_05327ra.bc',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/ck/05327_05332ra.bc',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/ck/05332_05337ra.bc',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/ck/05337_05342ra.bc',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/ck/05342_05347ra.bc',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/ck/05347_05352ra.bc',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/ck/05351_06027py_as_flown.bc',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/ck/05352_05357ra.bc',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/ck/05357_05362ra.bc',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/ck/05362_06002ra.bc',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/ck/06001_07001pa_gapfill_v14.bc',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/ck/cas_cda_20071203.bc',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/ck/cas_cda_20110315.bc',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/ck/cas_lemms_05109_20001_v2.bc',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/spk/050214R_SCPSE_04336_05015.bsp',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/spk/050411R_SCPSE_05015_05034.bsp',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/spk/050414RB_SCPSE_05034_05060.bsp',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/spk/050504R_SCPSE_05060_05081.bsp',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/spk/050513RB_SCPSE_05097_05114.bsp',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/spk/050606R_SCPSE_05114_05132.bsp',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/spk/050623R_SCPSE_05132_05150.bsp',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/spk/050708R_SCPSE_05150_05169.bsp',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/spk/050802R_SCPSE_05169_05186.bsp',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/spk/050825R_SCPSE_05186_05205.bsp',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/spk/050907R_SCPSE_05205_05225.bsp',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/spk/050922R_SCPSE_05225_05245.bsp',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/spk/051011R_SCPSE_05245_05257.bsp',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/spk/051021R_SCPSE_05257_05275.bsp',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/spk/051114R_SCPSE_05275_05293.bsp',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/spk/051213R_SCPSE_05293_05320.bsp',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/spk/060111R_SCPSE_05320_05348.bsp',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/spk/060213R_SCPSE_05348_06005.bsp',...
    'https://naif.jpl.nasa.gov/pub/naif/pds/data/co-s_j_e_v-spice-6-v1.0/cosp_1000/data/spk/110916R_SCPSE_05081_05097.bsp'};

initSPICEv(fullK(MK));

%% INPUT DATA

utctime='2005-11-26T12:19:11.276'; % Obtained of the label of the image
et=cspice_str2et(utctime);
target=encounter; % Target body
fixref=sprintf('IAU_%s',encounter); % Fixed reference
%abcorr='LT+S'; % Aberration correction (LT, LT+S, CN, CN+S...)
abcorr='NONE';
obsrvr=spacecraftid; % Observer
method='ELLIPSOID'; % Geometry of the body, use ellipsoid except for irregular bodies

%% INSTRUMENT DATA

f_INS='CASSINI_ISS_NAC'; % SPICE name of the instrument that recorded the image to be processed
% gipool returns the value of an integer kernel variable (scalar or array) from the kernel pool
% In this case, we want to query the number of pixels of the sensor
% this would be equivalent to read the file 
% https://naif.jpl.nasa.gov/pub/naif/CASSINI/kernels/ik/cas_iss_v10.ti
% and look for INS-82360_PIXEL_SAMPLES and INS-82360_PIXEL_LINES
[NPX,f]=cspice_gipool('INS-82360_PIXEL_SAMPLES',1,1); % number of pixels in X (number of columns)
[NPY,f]=cspice_gipool('INS-82360_PIXEL_LINES',1,1); % number of pixels in Y (number of rows)
[code_inst, found] = cspice_bodn2c(f_INS); % translates the name of a body or object to the corresponding SPICE integer ID code
if ( ~found )
    txt=sprintf( 'Unable to determine ID for instrument: %d',name);
    error(txt)
end

% Field-of-view parameters

room=4; % Number of 3 components vectors we expect to receive in bounds
% 4 is ok for a rectangle
[shape, iframe, bsight, bounds] = cspice_getfov(code_inst, room);

%% IMAGE DATA

name_img='RHEA_1511700504.tif';
img_data=imread(name_img);

imshow(img_data);
title('Original image');

figure

%% LON/LAT COMPUTATION

img3=single(zeros(NPY,NPX,3)); % 3--> RGB
img3(:,:,1)=img_data;  img3(:,:,2)=img_data;  img3(:,:,3)=img_data;

img3 = img3/max(single(img_data(:)));

c1=bounds(:,1); c2=bounds(:,2);
c3=bounds(:,3); c4=bounds(:,4);

lx=linspace(0,1,NPX); ly=linspace(0,1,NPY);

ppp=1; % This variable is just to control how often we redraw

% We will use these variables to find the latitude and longitude range of
% the image
minlat=1e10;  maxlat=-1e10;
minlon=1e10;  maxlon=-1e10;

% Structure with the data necessary for the second part
S.img=img_data;
S.lonmat=-1e3*ones(NPY,NPX); % The pixels are intially assigned to an arbitray value
S.latmat=-1e3*ones(NPY,NPX); % This will be changed for the pixels inside the planet

dref=iframe;

for i=1:1:NPX
    for j=1:1:NPY
        dvec=[c1(1)*(1-lx(i))+c2(1)*lx(i); c1(2)*(1-ly(j))+c3(2)*ly(j); 1]; % target pixel (z=1 by instrument definition)
        [spoint, trgepc, srfvec, found] = cspice_sincpt(method, target, et, fixref, abcorr, obsrvr, dref, dvec);
        
        if found
            
            img3(j,i,1)=0.5; % Change the red channel, so that the points inside can be identified
            s_rec=spoint;
            [range, s_lon, s_lat] = cspice_reclat(s_rec);
            
            lat=rad2deg(s_lat); % convert to degrees
            lon=rad2deg(s_lon); 
            
            if lon<0
                lon=lon+360;
            end

            % update maximum and minimum
            if lon>maxlon, maxlon=lon;  end
            if lon<minlon, minlon=lon;  end
            
            if lat>maxlat, maxlat=lat;  end
            if lat<minlat, minlat=lat;  end
            
            S.latmat(j,i)=lat;
            S.lonmat(j,i)=lon;
            
        else
            img3(j,i,3)=0.5; % Blue for the rest.
        end
    end
    if mod(ppp,100)==0 % Everey 100 pixels, redraw
        imshow(img3);
        axis on
        drawnow
    end
    ppp=ppp+1;
end

title(sprintf('Pixels identified, aberration correction =%s',abcorr));
% Save the data of the structure S
save('coor_lon_lat','S');

